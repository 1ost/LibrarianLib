import org.apache.tools.ant.filters.ReplaceTokens

dependencies {
    shade("com.github.thecodewarrior:Mirror:cdd1ec3034") {
        exclude group: 'org.jetbrains.kotlin'
    }
}

shadePackages('dev.thecodewarrior.mirror')

processResources {
    filesMatching("**/mods.toml") {
        filter(ReplaceTokens, tokens: ['version': rootProject.mod_version])
    }
}

task(generateModuleIndex).doLast {
    def resourceRoots = files([])
    allmodules.each { [it.sourceSets.main, it.sourceSets.test].each {
        resourceRoots.from(it.resources.sourceDirectories)
    } }

    def output = sourceSets.main.output.resourcesDir

    // assemble module names
    file(output.path + '/META-INF/modules').mkdirs()
    file(output.path + '/META-INF/modules/index.txt').text = allmodules.collect {
        it.name
    }.join("\n")
}

processResources.finalizedBy(generateModuleIndex)
